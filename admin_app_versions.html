<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage App Versions</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
  <style>
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
    }
  </style>
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#135bec",
            "background-light": "#f6f6f8",
            "background-dark": "#101622",
          },
          fontFamily: {
            display: ["Manrope", "sans-serif"],
          },
          borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
        },
      },
    };
  </script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark">
  <div class="relative flex min-h-screen w-full flex-col">
    <header class="sticky top-0 z-10 flex h-16 w-full items-center justify-between whitespace-nowrap border-b border-zinc-200/50 bg-background-light/80 px-6 backdrop-blur-sm dark:border-zinc-800/50 dark:bg-background-dark/80">
      <div class="flex items-center gap-4 text-zinc-900 dark:text-white">
        <svg class="size-6 text-primary" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
          <g clip-path="url(#clip0_6_535)">
            <path clip-rule="evenodd" d="M47.2426 24L24 47.2426L0.757355 24L24 0.757355L47.2426 24ZM12.2426 21H35.7574L24 9.24264L12.2426 21Z" fill="currentColor" fill-rule="evenodd"></path>
          </g>
          <defs>
            <clipPath id="clip0_6_535">
              <rect fill="white" height="48" width="48"></rect>
            </clipPath>
          </defs>
        </svg>
        <h2 class="text-lg font-bold leading-tight tracking-[-0.015em] text-zinc-900 dark:text-white">Enterprise App Store</h2>
      </div>
      <div class="flex items-center justify-end gap-4">
        <button class="flex h-10 w-10 cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-zinc-100 text-zinc-500 hover:bg-zinc-200 dark:bg-zinc-800 dark:text-zinc-400 dark:hover:bg-zinc-700">
          <span class="material-symbols-outlined text-xl">notifications</span>
        </button>
        <button class="flex h-10 w-10 cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-zinc-100 text-zinc-500 hover:bg-zinc-200 dark:bg-zinc-800 dark:text-zinc-400 dark:hover:bg-zinc-700">
          <span class="material-symbols-outlined text-xl">help</span>
        </button>
        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="User avatar image" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCCoua9JJj2dB0G4zgnHAxJG1LkmmAtDde7jfAL2qF73NymQ6nUGqXIualEcS-Aqh9wW6kC3MfC3MfKIzjT2J9jI4B1fglTw0EEzQRj-DKMeJa_UVEtbD7ukFYJsqy1enlQ-jgfBDmLACg6fiuuTvX5ot7oNA_IR_v-141cNH-qBv1QPW4bASYnclg3D76ng5kvFnYhvr5DJ9cASk7jNZQR481qPxUDMRYf_kYHm4hZtfu00sNf2DJ7WgFsqcIqBz2077OSa8T398A");'></div>
      </div>
    </header>
    <div class="flex flex-1">
      <aside class="sticky top-16 flex h-[calc(100vh-4rem)] w-64 flex-col justify-between border-r border-zinc-200/50 bg-background-light p-4 dark:border-zinc-800/50 dark:bg-background-dark">
        <div class="flex flex-col gap-4">
          <div class="flex items-center gap-3 px-2">
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Administrator's avatar" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCIh0E1246eqUM7mbPNV20rd84nCoO6yLjUJaRaXqF4MsFhll_wa_DcNq1bjc83cRGMweAAaCY1YMslzhEo2rjHpM6pB7SRK_5prEGO-WVYcPTiOzqTCqaxEa16Xj5fx-jPj8bgvWwQkSGDujNCXlILNXoa3YrBu7scsa1hW7irFQS6ZcUbV8YNtUfD8Pixc51E3uwoRrm-RgcH4XJp5KaFO5cCf9RstCfvN7rHO95W9hX8KpxMN7trRu0eZ8iOVk6p9WalL7PLmF0");'></div>
            <div class="flex flex-col">
              <h1 class="text-sm font-semibold text-zinc-900 dark:text-white">Alex Hartman</h1>
              <p class="text-sm text-zinc-500 dark:text-zinc-400">Administrator</p>
            </div>
          </div>
          <nav class="flex flex-col gap-1">
            <a class="flex items-center gap-3 rounded-lg px-3 py-2 text-zinc-500 hover:bg-zinc-100 dark:text-zinc-400 dark:hover:bg-zinc-800/50" href="admin_control_panel_overview_1.html">
              <span class="material-symbols-outlined text-xl">dashboard</span>
              <p class="text-sm font-medium">Dashboard</p>
            </a>
            <a class="flex items-center gap-3 rounded-lg px-3 py-2 text-zinc-500 hover:bg-zinc-100 dark:text-zinc-400 dark:hover:bg-zinc-800/50" href="admin_control_panel_overview_4.html">
              <span class="material-symbols-outlined text-xl">store</span>
              <p class="text-sm font-medium">Marketplaces</p>
            </a>
            <a class="flex items-center gap-3 rounded-lg px-3 py-2 text-zinc-500 hover:bg-zinc-100 dark:text-zinc-400 dark:hover:bg-zinc-800/50" href="admin_control_panel_overview_3.html">
              <span class="material-symbols-outlined text-xl">folder</span>
              <p class="text-sm font-medium">Folders</p>
            </a>
            <a class="flex items-center gap-3 rounded-lg bg-primary/10 px-3 py-2 text-primary dark:bg-primary/20" href="admin_control_panel_overview_2.html">
              <span class="material-symbols-outlined text-xl">apps</span>
              <p class="text-sm font-semibold">Applications</p>
            </a>
          </nav>
        </div>
        <div class="flex flex-col gap-1">
          <a class="flex items-center gap-3 rounded-lg px-3 py-2 text-zinc-500 hover:bg-zinc-100 dark:text-zinc-400 dark:hover:bg-zinc-800/50" href="enterprise_app_store_login_2.html">
            <span class="material-symbols-outlined text-xl">help_center</span>
            <p class="text-sm font-medium">Help Center</p>
          </a>
          <a class="flex items-center gap-3 rounded-lg px-3 py-2 text-zinc-500 hover:bg-zinc-100 dark:text-zinc-400 dark:hover:bg-zinc-800/50" href="enterprise_app_store_login_1.html">
            <span class="material-symbols-outlined text-xl">logout</span>
            <p class="text-sm font-medium">Log out</p>
          </a>
        </div>
      </aside>
      <main class="w-full flex-1 p-8">
        <div class="mx-auto flex w-full max-w-4xl flex-col gap-6">
          <div
            id="not-admin-message"
            class="hidden text-red-400 text-sm px-6 py-3 rounded-lg bg-red-950/40 border border-red-600/40 mb-4"
          >
            You do not have permission to access this page.
          </div>
          <div id="admin-section" class="space-y-6">
            <div class="flex flex-wrap items-start justify-between gap-4">
              <div class="flex min-w-72 flex-col gap-1">
                <p class="text-3xl font-bold tracking-tight text-zinc-900 dark:text-white">Manage Versions</p>
                <p id="app-name" class="text-zinc-500 dark:text-zinc-400">Loading app...</p>
              </div>
              <button
                class="rounded-lg border border-zinc-300 px-4 py-2 text-sm font-semibold text-zinc-700 hover:bg-zinc-100 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-800/50"
                onclick="window.history.back()"
              >
                Back
              </button>
            </div>
            <section class="space-y-4">
              <h3 class="text-lg font-semibold text-white">Version History</h3>
              <div id="versions-list" class="space-y-3"></div>
            </section>
            <section class="rounded-xl border border-slate-800 bg-slate-900/60 p-4 space-y-4">
              <h3 class="text-lg font-semibold text-white">Add Version</h3>
              <div class="grid grid-cols-1 gap-4">
                <div class="flex flex-col gap-2">
                  <label class="text-sm font-medium text-zinc-700 dark:text-zinc-200" for="version-name">Version</label>
                  <input id="version-name" class="rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 dark:border-zinc-700 dark:bg-zinc-800 dark:text-white" placeholder="1.0.1" />
                </div>
                <div class="flex flex-col gap-2">
                  <label class="text-sm font-medium text-zinc-700 dark:text-zinc-200" for="version-notes">Release Notes</label>
                  <textarea id="version-notes" rows="3" class="rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 dark:border-zinc-700 dark:bg-zinc-800 dark:text-white" placeholder="Describe what's new"></textarea>
                </div>
              </div>
              <div class="flex justify-end">
                <button id="btn-add-version" class="rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary/90">Add Version</button>
              </div>
            </section>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script type="module">
    import { protectAdminPage } from './admin-auth.js';
    import { supabase } from './supabase-client.js';

    function getAppIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('app');
    }

    async function initAdminPage() {
      const appNameEl = document.getElementById('app-name');
      const versionsList = document.getElementById('versions-list');
      const versionInput = document.getElementById('version-name');
      const notesInput = document.getElementById('version-notes');
      const addBtn = document.getElementById('btn-add-version');

      const appId = getAppIdFromUrl();
      if (!appId) {
        if (appNameEl) appNameEl.textContent = 'Application not specified';
        return;
      }

      async function loadAppDetails() {
        const { data: app, error } = await supabase.from('apps').select('name').eq('id', appId).maybeSingle();
        if (error || !app) {
          console.error('Failed to load app', error);
          if (appNameEl) appNameEl.textContent = 'Application not found';
          return;
        }
        if (appNameEl) appNameEl.textContent = app.name;
      }

      async function loadVersions() {
        if (versionsList) versionsList.innerHTML = '<p class="text-sm text-slate-400">Loading versions...</p>';
        const { data: versions, error } = await supabase
          .from('app_versions')
          .select('id, version, release_notes, created_at')
          .eq('app_id', appId)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Failed to load versions', error);
          if (versionsList) versionsList.innerHTML = '<p class="text-sm text-red-400">Failed to load versions.</p>';
          return;
        }

        if (!versions || versions.length === 0) {
          if (versionsList) versionsList.innerHTML = '<p class="text-sm text-slate-400">No versions added yet.</p>';
          return;
        }

        if (versionsList) {
          versionsList.innerHTML = versions
            .map((v) => {
              const date = v.created_at ? new Date(v.created_at).toLocaleDateString() : '';
              const notes = (v.release_notes || '').replace(/</g, '&lt;');
              return `
                <article class="rounded-lg border border-slate-800 bg-slate-900/60 p-3">
                  <div class="flex items-center justify-between mb-1">
                    <div class="font-semibold text-white">Version ${v.version}</div>
                    <div class="text-xs text-slate-500">${date}</div>
                  </div>
                  <p class="text-xs text-slate-200 whitespace-pre-wrap">${notes}</p>
                </article>
              `;
            })
            .join('');
        }
      }

      addBtn?.addEventListener('click', async () => {
        const version = versionInput.value.trim();
        const notes = notesInput.value.trim();

        if (!version) {
          alert('Version is required');
          return;
        }

        const { error } = await supabase.from('app_versions').insert({
          app_id: appId,
          version,
          release_notes: notes || null,
        });

        if (error) {
          console.error(error);
          alert('Failed to add version: ' + error.message);
          return;
        }

        await supabase.from('apps').update({ version }).eq('id', appId);

        versionInput.value = '';
        notesInput.value = '';
        await loadVersions();
      });

      await loadAppDetails();
      await loadVersions();
    }

    protectAdminPage(initAdminPage);
  </script>
</body>
</html>
